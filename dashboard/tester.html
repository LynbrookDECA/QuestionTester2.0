<!DOCTYPE html>
<html>
<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-109731534-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-109731534-1');
    </script>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Lynbrook DECA - Dashboard</title>
    <link rel="icon" href="../img/favico.png"></link>

    <link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/datepicker3.css" rel="stylesheet">
    <link href="css/bootstrap-table.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
    <link href="css/tester.css" rel="stylesheet">

    <link href="https://fonts.googleapis.com/css?family=Montserrat|Open+Sans" rel="stylesheet">

    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>

    <script src="js/respond.min.js"></script>
    <![endif]-->


    <script src="https://www.gstatic.com/firebasejs/3.6.5/firebase.js"></script>
    <script>
        var config = {
            apiKey: "AIzaSyBdf755F2RHw5-IUsMR1rYUyCGvpdvKSOk",
            authDomain: "lynbrook-deca.firebaseapp.com",
            databaseURL: "https://lynbrook-deca.firebaseio.com",
            storageBucket: "lynbrook-deca.appspot.com",
            messagingSenderId: "105997057044"
        };
        firebase.initializeApp(config);
    </script>

</head>

<body class = "bodyDisplay" style = "display:none">
<nav class="navbar navbar-inverse navbar-fixed-top dash-header" role="navigation" >
    <div class="container-fluid">
        <div class="navbar-header">

            <div id="navbarlogo">
            </div>

            <!-- <div id="lynbrookdeca">
                <p><a href="../index.html">Lynbrook DECA</a></p>
            </div> -->

            <button type="button"  id ="icon-bar1" style = "background-color: #1F3A93; margin-top:17px; margin-right: 5px !important" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar" style = "color:brown" ></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>


            <!-- <span style = "padding-top: 11px; color: #3366FF; display:none; padding-right: 10px;" id= "icon-bar1"class="glyphicon glyphicon-align-justify glyphicon-l"></span>	 -->

            <!-- <a class="navbar-brand" href="dashboard.html"><span>Lynbrook DECA</span> Admin</a> -->
            <ul class = "dash-hover">

                
                <ul class="user-menu">
                    <li class="dropdown pull-right">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown"><span class="glyphicon glyphicon-user"></span><span class ="user-name"> User </span><span class="caret"></span></a>
                        <ul class="dropdown-menu" role="menu" style ="margin-top:20px">
                            
                            <li style ="padding-top:0"><a href="#" class="logout-button"><span class="glyphicon glyphicon-log-out"></span> Logout</a></li>

                        </ul>

                    </li>
                </ul>
            </ul>
        </div>

    </div><!-- /.container-fluid -->
</nav>
<div id="" class="nav-menu" style="padding-top: 0px; display:none">


    <ul class="nav menu" style = "text-align:center; background-color:whitesmoke;">
        <li><a href="../index.html">Home</a></li>
        <li><a href="../about.html">About</a></li>
        <li><a href="../calendar.html">Calender</a></li>
        <li><a href="../events.html">Events</a></li>
        <li><a href="../conferences.html">Conferences</a></li>
        <li><a href="profile.html">Profile</a></li>
        <li><a class="logout-button" href = "#">Logout</a></li>



        <li role="presentation" class="divider"></li>

    </ul>
</div><!--/.sidebar-->
<div id="" class="test" style="padding-top: 0px; display:none">


        <ul class="nav menu" style = "text-align:center; background-color:white">
            <li class="active1"><a href="tests.html" style = "color: white"><span id = "test1" class="glyphicon glyphicon-briefcase"></span> Question Tester </a></li>
            <li role="presentation" class="divider"></li>


        </ul>
    </div><!--/.sidebar-->

    <div id="sidebar-collapse" class="col-sm-3 col-lg-2 sidebar" style="padding-top: 40px">

        <ul class="nav menu" style = "text-align:left; background-color:white">
           
            <li class="active1"><a href="tests.html" style = "color: white"><span id = "test1" class="glyphicon glyphicon-briefcase"></span> Question Tester </a></li>
            <li role="presentation" class="divider"></li>
        </ul>
    </div><!--/.sidebar-->

<div class="col-sm-9 col-sm-offset-3 col-lg-10 col-lg-offset-2 main">
    <div class="row">
        <ol class="breadcrumb">
            <li><a href="tests.html"><span class="glyphicon glyphicon-home"></span></a></li>
            <li><a href="tests.html"><span class="glyphicon glyphicon-file"></span></a> Tests </li>
        </ol>
    </div><!--/.row-->

    <div class="row">
        <div class="col-lg-12">
            <h1 class="page-header" style = "text-align:center; font-family: Raleway">DECA Question Tester</h1>
            <hr>
        </div>
    </div><!--/.row-->
    <div class="container-fluid">

        <div class="row">
            <div class="col-md-7 col-md-offset-1 question" id="q" style="background-color: white; ">
                <p class="qbox" id="question"> Loading... Refresh if nothing shows up. </p>
                <button class="option qbox" id="A" onclick="checkAnswer('A', true)"> Loading... </button>
                <button class="option qbox" id="B" onclick="checkAnswer('B', true)"> Loading... </button>
                <button class="option qbox" id="C" onclick="checkAnswer('C', true)"> Loading... </button>
                <button class="option qbox" id="D" onclick="checkAnswer('D', true)"> Loading... </button>

            </div>


            <div class="col-md-3 doughnutChart"  style="background-color: white; ">
                <p id="title"> Progress Report </p>
                <div id="chart" style="width:60%; margin-left: 20%;">
                    <canvas class="chart" id="doughnut-chart" ></canvas>
                </div>
                <p id="currentScore"> Current Score: </p>
            </div>

            <div class="col-md-3">
                <button id="allQ" >History</button>
                <button id="restart" onclick="restartTest()">Restart</button>
            </div>


            <div class="col-md-7 col-md-offset-1" id="result">
                <p id="resultText"> Congrats! You got the right answer! </p>
            </div>

            <div class="col-md-7 col-md-offset-1">
                <button id="next" onclick="next()">Next</button>
            </div>

        </div><!--/.row-->

    </div>

</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src = "js/dashboard-parse.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/bootstrap-datepicker.js"></script>
<script src="js/bootstrap-table.js"></script>

<script>
    !function ($) {
        $(document).on("click","ul.nav li.parent > a > span.icon", function(){
            $(this).find('em:first').toggleClass("glyphicon-minus");
        });
        $(".sidebar span.icon").find('em:first').addClass("glyphicon-plus");
    }(window.jQuery);

    $(window).on('resize', function () {
        if ($(window).width() > 768) $('#sidebar-collapse').collapse('show')
    })
    $(window).on('resize', function () {
        if ($(window).width() <= 767) $('#sidebar-collapse').collapse('hide')
    })
</script>

<script>

    function disableHistory(bool) {
        document.getElementById('allQ').disabled = bool;

        resetTester();
    }

    $('#allQ').click(function () {
        document.getElementById('next').disabled = true;
        disableHistory(true);
        var qObjects = document.getElementsByClassName('qbox');
        for (var i = 0; i < qObjects.length; i++) {
            qObjects[i].hidden = true;
        }

        var div = document.getElementById('q');
        for (var i = 0; i < 100; i++) {
            var userAnswer = userData['history'].charAt(i);
            var actualAnswer = rightAnswers.charAt(i);

            var btn;

            if (historyCreated == false) {

                btn = document.createElement('button');
                var txt = document.createTextNode(String(i + 1));
                btn.appendChild(txt);
                btn.setAttribute('type', 'button');
                btn.setAttribute('id', "" + i);
                btn.setAttribute('onclick', "questionClick(this.getAttribute('id'))");
                btn.setAttribute('class', 'questionButton button' + i);

            } else {
                btn = document.getElementById(i.toString());
            }

            if (userAnswer == actualAnswer) {
                btn.style.backgroundColor = '#29AB87'
            } else {
                if (userAnswer == 'E') {
                    btn.style.backgroundColor = '#ffb53e';
                    if (i != userData['currentQuestion'] - 1) {
                        btn.disabled = true;
                        btn.style.backgroundColor = '#C0C0C0';
                    }
                } else {
                    btn.style.backgroundColor = '#f9243f'
                }
            }

            div.appendChild(btn);
        }
    });

    //questionNum = 0-99
    function questionClick(questionNum) {
        var qObjects = document.getElementsByClassName('qbox');
        var bObjects = document.getElementsByClassName('questionButton');
        for (var i = 0; i < bObjects.length; i++) {
            bObjects[i].hidden = true;
        }
        for (var i = 0; i < qObjects.length; i++) {
            qObjects[i].hidden = false;
        }
        disableHistory(false);
        resetTester();

        if (parseInt(questionNum)+1 == userData['currentQuestion']) {
            document.getElementById('next').disabled = false;
            updateQuestion(userData['currentQuestion'])
        } else {
            updateQuestion(parseInt(questionNum)+1);
            checkAnswer((userData['history'].charAt(questionNum)), false);
        }

    }

</script>


<script type="text/javascript">
    var testData;
    var rightAnswers = "";
    var userData;
    var questionData;
    var explanationData;
    var historyCreated = false;

    //Get TestID from URL
    var url_string = window.location.href;
    var url = new URL(url_string);
    var testID = url.searchParams.get("testID");

    getTestData(testID);

    // String function to replace character at particular index
    String.prototype.replaceAt=function(index, replacement) {
        return this.substr(0, index) + replacement+ this.substr(index + replacement.length);
    }

    //Get the TestData
    function getTestData() {
        var url = 'https://sheets.googleapis.com/v4/spreadsheets/1B84hzrKLUS1SXRH7HZzcgZ7sxXcOxNPh_Uy6cJyNx-Q/values/' + testID + '!A2:H101?key=AIzaSyASXs9-IIZv3QywWdaB2DFpitGqZCb-cWM';
        // Grab the Sheets Data
        fetch(url).then(function (response) {
            return response.json();
        }).then(function (data) {
            console.log(data);
            testData = data["values"];
            for (var i = 0; i < testData.length; i++) {
                rightAnswers += testData[i][6];
            }
            console.log(rightAnswers);
            getUserData(testID);
        }).catch(function () {
            console.log("Didn't work. Figure out why.");
        });
    }

    function getUserData(testID) {
        firebase.auth().onAuthStateChanged(function (user) {
            if (user) {
                firebase.database().ref('/userData/' + globalUserID + "/tests/" + testID).once('value').then(function (snapshot) {

                    if (snapshot.val()) {
                        console.log("exists in database");
                        userData = {
                            'currentQuestion': snapshot.val().currentQuestion,
                            'questionsRight': snapshot.val().questionsRight,
                            'questionsWrong': snapshot.val().questionsWrong,
                            'history': snapshot.val().history,
                        };
                        updateQuestion(snapshot.val().currentQuestion);
                        makeDoughnutChart();

                    } else {
                        console.log("Doesn't exist in database");
                        userData = {'currentQuestion': 1,
                            'questionsRight': 0,
                            'questionsWrong': 0,
                            'history': "EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE"
                        };
                        firebase.database().ref('/userData/' + globalUserID + "/tests/" + testID).update(userData);
                        updateQuestion(userData['currentQuestion']);
                        makeDoughnutChart();
                    }


                });
            }
        });
    }

    function updateQuestion(questionNum) {
        questionData = testData[questionNum-1];
        if (questionData[7] != undefined) {
            explanationData = "Here's why: " + questionData[7];
        }
        else {
            explanationData = "Refer to testing folder for explanation.";
        }
        

        console.log(testData);
        document.getElementById('question').innerHTML = questionNum + ". " + questionData[1];
        document.getElementById('A').innerHTML = "A. " + questionData[2];
        document.getElementById('B').innerHTML = "B. " + questionData[3];
        document.getElementById('C').innerHTML = "C. " + questionData[4];
        document.getElementById('D').innerHTML = "D. " + questionData[5];
    }


    function checkAnswer(selectedAnswer, update) {
        if (document.getElementById("result").style.display === 'block') {
            console.log("Buttons are disabled")
        } else {
            var buttons = document.getElementsByClassName("option");
            for (var i = 0; i < buttons.length; i++) {
                buttons[i].style.backgroundColor = "white";
                buttons[i].disabled = true;
            }


            var result = document.getElementById("result");
            var resultText = document.getElementById("resultText");
            result.style.display = "block";
            if (questionData[6] == selectedAnswer) {
                result.style.color = "#29AB87";
                resultText.innerHTML = "Congrats! You got the right answer! " + explanationData;
                document.getElementById(selectedAnswer).style.backgroundColor = "#29AB87";
                if (update) {
                    updateUserData(true, selectedAnswer);
                    makeDoughnutChart();
                }
            } else {
                result.style.color = "#29AB87";
                resultText.innerHTML = "Whoops! The correct answer was " + questionData[6] + ". " + explanationData;
                document.getElementById(selectedAnswer).style.backgroundColor = "#f9243f";
                document.getElementById(questionData[6]).style.backgroundColor = "#00A86B";
                if (update) {
                    updateUserData(false, selectedAnswer);
                    makeDoughnutChart();
                }
            }
        }
    }

    function updateUserData(result, ans) {
        if (result) {
            userData['questionsRight'] = userData['questionsRight'] + 1;
        } else {
            userData['questionsWrong'] = userData['questionsWrong'] + 1;
        }
        userData['history'] = userData['history'].replaceAt(userData['currentQuestion']-1, ans);
        userData['currentQuestion'] = userData['currentQuestion'] + 1;
        updateFirebase();
    }

    function updateFirebase() {
        firebase.database().ref('/userData/' + globalUserID + "/tests/" + testID).update({
            currentQuestion: userData['currentQuestion'],
            questionsRight: userData['questionsRight'],
            questionsWrong: userData['questionsWrong'],
            history: userData['history']
        })
    }

    function next() {
        if (document.getElementById("result").style.display === 'block') {
            if (userData['currentQuestion'] > 100){
                alert('You have completed this test!');
            } else {
                resetTester();
                updateQuestion(userData['currentQuestion']);
            }
        }
    }

    function resetTester() {
        document.getElementById('result').style.display = "none";
        var buttons = document.getElementsByClassName("option");

        for (var i = 0; i < buttons.length; i++) {
            buttons[i].disabled = false;
            buttons[i].style="";
        }
    }

    function restartTest() {
        userData = {'currentQuestion': 1,
            'questionsRight': 0,
            'questionsWrong': 0,
            'history': "EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE"
        };
        firebase.database().ref('/userData/' + globalUserID + "/tests/" + testID).update(userData);
        questionClick(0);
        updateQuestion(userData['currentQuestion']);
        disableHistory(false);
        makeDoughnutChart();

    }

    function makeDoughnutChart() {
        var doughnutData = {
            datasets: [{
                data: [userData["questionsRight"], userData["questionsWrong"]],
                backgroundColor: ["#30a5ff", "#f9243f"]
            }],
            labels: [
                'Right',
                'Wrong'
            ],
        };
        var doughnutDataEmpty = {
            datasets: [{
                data: [1, 1],
                backgroundColor: ["#30a5ff", "#f9243f"]
            }],
            labels: [
                'None',
                'None'
            ],
        };
        var options = {
            layout: {
                padding: {
                    bottom: 20
                }
            },
            legend: {
                display: false,
                reverse: true,
                position: 'bottom',
                labels: {
                    // This more specific font property overrides the global property
                    fontColor: 'black',
                    fontFamily: 'Avenir Next'
                }
            },
        };
        var finalData = {}
        if (userData["currentQuestion"] == 1) {
            document.getElementById("currentScore").innerHTML = "No Questions Answered Yet";
            finalData = doughnutDataEmpty;
        } else {
            document.getElementById("currentScore").innerHTML = "Current Score: " + userData["questionsRight"] + " / " + (userData["currentQuestion"] - 1);
            finalData = doughnutData;
        }
        var ctx = document.getElementById("doughnut-chart").getContext("2d");
        var myDoughnutChart = new Chart(ctx, {
            type: 'doughnut',
            data: finalData,
            options: options
        });

    }



</script>


</body>

</html>

